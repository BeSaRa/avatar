import{c as u}from"./chunk-W67NKLBJ.js";import{c as O}from"./chunk-IMBJOZZZ.js";import{a as r}from"./chunk-FWDT53KA.js";import{a as L}from"./chunk-KYYC7DO4.js";import{b as C}from"./chunk-55XIR25M.js";import{a as h,b as l}from"./chunk-7YC6CIPS.js";import{g as p}from"./chunk-UUNGGFH6.js";import{B as a,D,Db as A,K as c,P as n,ka as s,na as M,ta as T,x as I}from"./chunk-FK5TGTUL.js";var S={CHATBOT:"CHATBOT",MEDIA:"MEDIA",INTERACTIVE_CHAT:"INTERACTIVE_CHAT",SEARCH:"SEARCH",AVATAR:"AVATAR",SPEECH:"SPEECH",DOCUMENT_INTELLIGENCE:"DOCUMENT_INTELLIGENCE",ADMIN:"ADMIN",CHAT_HISTORY:"CHAT_HISTORY",ADMIN_CRAWLER:"ADMIN_CRAWLER",ADMIN_UPLOAD_BLOB:"ADMIN_UPLOAD_BLOB",ADMIN_GET_BLOB:"ADMIN_GET_BLOB",ADMIN_GET_ALL_CONTAINERS:"ADMIN_GET_ALL_CONTAINERS",ADMIN_GET_SUBFOLDER:"ADMIN_GET_SUBFOLDER",ADMIN_DELETE_SUBFOLDER:"ADMIN_DELETE_SUBFOLDER",ADMIN_DELETE_BLOB_BY_METADATA:"ADMIN_DELETE_BLOB_BY_METADATA",ADMIN_DELETE_BLOB_BY_TITLE:"ADMIN_DELETE_BLOB_BY_TITLE",ADMIN_RESET_INDEX:"ADMIN_RESET_INDEX",ADMIN_RUN_INDEXER:"ADMIN_RUN_INDEXER",ADMIN_INDEX_INFO:"ADMIN_INDEX_INFO",ADMIN_INDEXES_NAMES:"ADMIN_INDEXES_NAMES",MEDIA_GENERATE_REPORT:"MEDIA_GENERATE_REPORT",MEDIA_CRAWL:"MEDIA_CRAWL",MEDIA_SENTIMENT:"MEDIA_SENTIMENT",MEDIA_DETECT_LANGUAGE:"MEDIA_DETECT_LANGUAGE",MEDIA_KEY_PHRASES:"MEDIA_KEY_PHRASES",MEDIA_ENTITY_RECOGNITION:"MEDIA_ENTITY_RECOGNITION",MEDIA_IMAGE_ANALYSIS:"MEDIA_IMAGE_ANALYSIS",MEDIA_IMAGE_EMBEDDING:"MEDIA_IMAGE_EMBEDDING",CHATBOT_WEBSITE:"CHATBOT_WEBSITE",CHATBOT_UPLOAD_DOCUMENT:"CHATBOT_UPLOAD_DOCUMENT",INTERACTIVE_DEPARTMENT_TYPES:"INTERACTIVE_DEPARTMENT_TYPES",INTERACTIVE_VACATION_TYPES:"INTERACTIVE_VACATION_TYPES",INTERACTIVE_SUBMIT_FORM:"INTERACTIVE_SUBMIT_FORM",INTERACTIVE_APPROVE:"INTERACTIVE_APPROVE",INTERACTIVE_REJECT:"INTERACTIVE_REJECT",INTERACTIVE_PENDING:"INTERACTIVE_PENDING",INTERACTIVE_FILTER_FORMS:"INTERACTIVE_FILTER_FORMS",INTERACTIVE_ALL_FORMS:"INTERACTIVE_ALL_FORMS",AVATAR_START_STREAM:"AVATAR_START_STREAM",AVATAR_SEND_CANDIDATE:"AVATAR_SEND_CANDIDATE",AVATAR_SEND_ANSWER:"AVATAR_SEND_ANSWER",AVATAR_RENDER_TEXT:"AVATAR_RENDER_TEXT",AVATAR_STOP_RENDER:"AVATAR_STOP_RENDER",AVATAR_CLOSE_STREAM:"AVATAR_CLOSE_STREAM",SPEECH_TOKEN:"SPEECH_TOKEN",SPEECH_TRANSCRIPT:"SPEECH_TRANSCRIPT",CHAT_HISTORY_CONVERSATION:"CHAT_HISTORY_CONVERSATION",CHAT_HISTORY_ALL_CONVERSATION:"CHAT_HISTORY_ALL_CONVERSATION",CHAT_HISTORY_CHAT:"CHAT_HISTORY_CHAT",CHAT_HISTORY_SENTIMENT:"CHAT_HISTORY_SENTIMENT",CHAT_HISTORY_ADD_FEEDBACK:"CHAT_HISTORY_ADD_FEEDBACK",CHAT_HISTORY_BOT_NAMES:"CHAT_HISTORY_BOT_NAMES",CHAT_HISTORY_ADD_MSG:"CHAT_HISTORY_ADD_MSG",DOCUMENT_INTELLIGENCE_ANALYZE_PDF:"DOCUMENT_INTELLIGENCE_ANALYZE_PDF",SEARCH_BOT_NAME:"SEARCH_BOT_NAME",ADMIN_ADD_PERMISSION_TO_USER:"ADMIN_ADD_PERMISSION_TO_USER",ADMIN_ADD_PERMISSION_TO_TABLE:"ADMIN_ADD_PERMISSION_TO_TABLE",CHATBOT_LEGAL:"CHATBOT_LEGAL",CHATBOT_MEDIA:"CHATBOT_MEDIA",CHATBOT_INTERACTIVE:"CHATBOT_INTERACTIVE",CHATBOT_QREP:"CHATBOT_QREP",CHATBOT_DOC_INTELLIGENCE:"CHATBOT_DOC_INTELLIGENCE",ADMIN_ADD_USER:"ADMIN_ADD_USER",ADMIN_DELETE_USER:"ADMIN_DELETE_USER",ADMIN_UPDATE_USER:"ADMIN_UPDATE_USER",ADMIN_GET_ALL_USER:"ADMIN_GET_ALL_USER",ADMIN_GET_USER:"ADMIN_GET_USER",ADMIN_GET_PERMISSION:"ADMIN_GET_PERMISSION",ADMIN_GET_ALL_PERMISSION:"ADMIN_GET_ALL_PERMISSION",ADMIN_REMOVE_PERMISSION:"ADMIN_REMOVE_PERMISSION",ADMIN_ASSIGN_PERMISSION:"ADMIN_ASSIGN_PERMISSION",ADMIN_GET_ALL_SETTINGS:"ADMIN_GET_ALL_SETTINGS",ADMIN_ADD_SETTING:"ADMIN_ADD_SETTING",ADMIN_UPDATE_SETTING:"ADMIN_UPDATE_SETTING",ADMIN_DELETE_SETTING:"ADMIN_DELETE_SETTING",ADMIN_GET_SETTING:"ADMIN_GET_SETTING"};var o=class{_permissions=[];_permissionsKeys=[];_refresh_token=A("");_access_token=A("");_user_id=A("");_username=A("");isRefreshing=A(!1);get username(){return this._username()}set username(e){this._username.set(e)}get user_id(){return this._user_id()}set user_id(e){this._user_id.set(e)}set permissions(e){this._permissions=e,this._permissionsKeys=e.map(_=>_.key)}get permissions(){return this._permissions}get permissionsKeys(){return this._permissionsKeys}get access_token(){return this._access_token()}set access_token(e){this._access_token.set(e)}set refresh_token(e){this._refresh_token.set(e)}get refresh_token(){return this._refresh_token()}hasPermission(e){return this._permissionsKeys.includes(S[e])}hasAnyPermission(e){return e.some(_=>this._permissionsKeys.includes(S[_]))}hasAllPermission(e){return e.every(_=>this._permissionsKeys.includes(S[_]))}hasToken(){return!!this.access_token&&!this.isRefreshing()}};var R={TOKEN_HEADER_KEY:"Authorization"};var m=class N{_http=T(p);_urlService=T(h);_router=T(O);messagesService=T(u);lang=T(l);commonService=T(L);store=T(C);$applicationUser=A(new o);$isAuthenticated=A(!1);login(e,_){let t=`${this._urlService.URLS.USER}/login`;return this._http.post(t,{username:e,password:_}).pipe(s(E=>this.$applicationUser.update(i=>(i.access_token=E.access_token,i.refresh_token=E.refresh_token,i.permissions=E.permissions,i.user_id=E.user_id,i.username=E.username,i))),s(E=>localStorage.setItem(r.USER,JSON.stringify(E))),s(E=>localStorage.setItem(r.PERMISSIONS_KEYS,JSON.stringify(E.permissions.map(i=>i.key)))),s(()=>this.$isAuthenticated.set(!0)),s(()=>this._router.navigate(["/home"])),s(()=>this.messagesService.showInfo(`${this.lang.locals.welcome_user}, ${e}! ${this.lang.locals.welcome_back}`)),s(()=>localStorage.setItem(r.USERNAME,e)),s(()=>this.setExpirationSession()),D(E=>this.handleSpeechToken(E)),n(()=>(this.$isAuthenticated.set(!1),this.messagesService.showError(`${this.lang.locals.login_failed}`),I(new o))))}generateRefreshToken(){let e=`${this._urlService.URLS.USER}/refresh-token`;this.$applicationUser().isRefreshing.set(!0);let _={headers:{[R.TOKEN_HEADER_KEY]:this.$applicationUser().refresh_token}};return this._http.get(e,_).pipe(s(t=>this.$applicationUser.update(E=>(E.refresh_token=t.refresh_token,E))),s(()=>this.$applicationUser().isRefreshing.set(!1)),n(()=>(this.$applicationUser().isRefreshing.set(!1),I({refresh_token:""}))))}generateAccessToken(){let e=`${this._urlService.URLS.USER}/access-token`,_={headers:{[R.TOKEN_HEADER_KEY]:this.$applicationUser().access_token}};return this._http.get(e,_).pipe(s(t=>this.$applicationUser.update(E=>(E.access_token=t.access_token,E)),n(()=>(this._router.navigate(["/auth/login"]),I({access_token:""})))))}tryAuthenticate(){let e=localStorage.getItem(r.USER);e&&this.$applicationUser.update(_=>{let t=JSON.parse(e);return _.access_token=t.access_token,_.refresh_token=t.refresh_token,_.permissions=t.permissions,_}),this.$isAuthenticated.set(!!e),!this.$isAuthenticated()&&this._router.navigate(["/auth/login"])}logout(){this.$isAuthenticated.set(!1),this.$applicationUser.set(new o),localStorage.removeItem(r.USER),localStorage.removeItem(r.TOKEN_EXPIRY),this.logoutSubscription?.unsubscribe(),this._router.navigate(["/auth/login"])}startAutoLogout(e){let _=e-Date.now();console.log(_/1e3),this.logoutSubscription?.unsubscribe(),this.logoutSubscription=c(_).subscribe(()=>{this.logout(),this.messagesService.showError(this.lang.locals.session_timeout)})}checkAutoLogoutOnRefresh(){let e=localStorage.getItem(r.TOKEN_EXPIRY);if(!e)return;let _=parseInt(e,10);Date.now()>=_?(this.logout(),this.messagesService.showError(this.lang.locals.session_timeout)):this.startAutoLogout(_)}setExpirationSession(){let e=Date.now()+30*60*1e3;localStorage.setItem(r.TOKEN_EXPIRY,e.toString()),this.startAutoLogout(e)}getUsername(){return localStorage.getItem(r.USERNAME)??""}handleSpeechToken(e){return this.commonService.generateSpeechToken().pipe(s(_=>this.store.updateSpeechToken(_)),n(_=>(console.error("Error generating speech token:",_),I(null))),a(()=>e))}static \u0275fac=function(_){return new(_||N)};static \u0275prov=M({token:N,factory:N.\u0275fac,providedIn:"root"})};export{R as a,m as b};
