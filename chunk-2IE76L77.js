import{a as R}from"./chunk-FWDT53KA.js";import{a as U}from"./chunk-2LKYGCHS.js";import{c as x}from"./chunk-X5CIYX27.js";import{d as w,e as A}from"./chunk-ANBYP55K.js";import{b as I}from"./chunk-EARLHVX5.js";import{ia as S}from"./chunk-MFSWGIIO.js";import{a as y}from"./chunk-DYBLNUKQ.js";import{c as M,g as T}from"./chunk-PXW4CVT7.js";import{B as p,H as C,P as m,W as h,X as f,a as l,b as g,ka as b,na as v,ta as u,x as d}from"./chunk-O6QGGAL6.js";function E(i){return class extends i{clone(t){let s=this.constructor;return Object.assign(new s,this,t)}}}var c=class extends E(U){constructor(t="",s="user",o=void 0){super();this.content=t;this.role=s;this.chatType=o}end_turn;function_call;tool_calls};var O=class i{http=u(T);urlService=u(y);adminService=u(x);store=u(I);botNameCtrl=new S("",{nonNullable:!0});chatType;sendMessage(r,t,s){this.chatType=s??t;let o=`${this.urlService.URLS.CHAT}/${t}`;return this.messages.update(e=>[...e,new c(r,"user",s??t)]),this.http.post(o,l(l(l({messages:this.messages()},this.store.streamId()?{stream_id:this.store.streamId()}:null),this.conversationId()?{conversation_id:this.conversationId()}:null),this.getUserId()?{user_id:this.getUserId()}:null)).pipe(m(e=>{throw new c().clone({content:e.message,role:"error",chatType:s??t}),new Error(e)}),p(e=>(e.message.content=w(A(e.message.content,e.message)),e.message=new c().clone(g(l({},e.message),{chatType:s??t})),this.conversationId.set(e.message.conversation_id),this.messages.update(a=>[...a,e.message]),e)))}processFormattedText(r){let t=[...r.matchAll(/href="(.*?)"/g)];if(t.length===0)return console.log("No matches found in formatted text."),d(r);let s=t.map(o=>{let e=o[1];return e.includes("blob.core.windows.net")?this.adminService.secureUrl(e).pipe(p(a=>({match:o[0],replacement:o[0].replace(e,a)})),m(()=>d({match:o[0],replacement:o[0]}))):d({match:o[0],replacement:o[0]})});return C(s).pipe(p(o=>(o.forEach(({match:e,replacement:a})=>{r=r.replace(e,a)}),r)))}onBotNameChange(){return this.botNameCtrl.valueChanges.pipe(h(),b(()=>{this.conversationId.set(""),this.messages.set([])}))}uploadDocument(r,t,s){let o=`${this.urlService.URLS.CHATBOT_UPLOAD_DOCUMENT}`,e=new FormData;Array.from(r).forEach(n=>{e.append("files",n,n.name)});let a=new M().set("bot_name",t);return s&&(a=a.set("conversation_id",s)),this.http.post(o,e,{params:a}).pipe(p(n=>(this.conversationId.set(n.data||""),n.data)),f(()=>this.sendMessage("summarize",t).pipe(m(n=>{throw console.error("Error sending summarize message:",n),n}))),m(n=>{throw console.error("Error uploading document:",n),n}))}getUserId(){let r=localStorage.getItem(R.USER),t="";return r&&(t=JSON.parse(r).user_id),t}static \u0275fac=function(t){return new(t||i)};static \u0275prov=v({token:i,factory:i.\u0275fac,providedIn:"root"})};export{E as a,c as b,O as c};
