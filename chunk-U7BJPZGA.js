import{a as Me}from"./chunk-KHOFVO4S.js";import{a as ze,b as Ie,c as Le}from"./chunk-HHPITOA4.js";import{a as Ee}from"./chunk-QZPNBOA6.js";import{a as we}from"./chunk-KQIHERE2.js";import{a as W}from"./chunk-GPJGLLXF.js";import{a as xe}from"./chunk-FTP5OKF7.js";import{c as fe}from"./chunk-5BZPFUY4.js";import"./chunk-J2HB2Y4E.js";import{a as Re}from"./chunk-GNG7ILZA.js";import{a as Ae}from"./chunk-SIWWJH65.js";import"./chunk-2IE76L77.js";import{b as ke}from"./chunk-B26V2M5L.js";import{a as $e}from"./chunk-73NYINMC.js";import"./chunk-FWDT53KA.js";import{a as He}from"./chunk-XIYR6XWG.js";import"./chunk-QW4DZL5W.js";import"./chunk-2LKYGCHS.js";import"./chunk-X5CIYX27.js";import"./chunk-6IGLDT6K.js";import{a as be}from"./chunk-2N4EDZNV.js";import{b as Q}from"./chunk-ANBYP55K.js";import{b as Ce}from"./chunk-EARLHVX5.js";import{a as Ve}from"./chunk-HC4WQR6A.js";import{b as Te,c as ye}from"./chunk-WLQKWWON.js";import{F as _e}from"./chunk-MFSWGIIO.js";import"./chunk-OK5S6IU3.js";import{b as Se}from"./chunk-DYBLNUKQ.js";import"./chunk-PXW4CVT7.js";import{$b as j,Ac as w,B as z,Bc as _,Bd as he,Db as A,Eb as T,Ha as u,Hd as ve,Ia as g,Ja as k,Jb as ie,Ka as M,Kc as se,La as ee,Lc as le,M as Z,N as P,Na as te,Nc as B,Ob as y,Oc as ce,P as J,Pc as N,Qc as U,Rc as pe,Sb as l,Sc as de,T as O,V as K,Vb as ne,Wb as re,X as $,Xb as f,Yb as oe,_b as F,ac as a,bc as s,cc as c,f as Oe,fd as me,gc as H,ha as b,hd as ue,i as Y,ia as E,jc as h,ka as x,lb as D,lc as d,mb as C,q as I,s as L,sb as r,ta as S,vd as ge,w as R,wc as V,xa as X,xc as ae,yc as q,zc as p}from"./chunk-O6QGGAL6.js";var v=Oe($e());var De=["baseElement"],Fe=["waves"],je=["video"],qe=["idleVideo"],Be=["container"],Ne=(i,n)=>n.id,Ue=i=>({"-start-10 opacity-100":i}),Pe=(i,n,t)=>({"bg-red-600":i,"bg-green-700":n,"bg-orange-500":t}),Qe=i=>({hidden:i}),We=(i,n)=>({"mdi-chevron-down":i,"mdi-chevron-up":n});function Ge(i,n){if(i&1&&(a(0,"span",8),p(1),s()),i&2){let t=d();r(),w(t.recognizedText())}}function Ye(i,n){if(i&1&&c(0,"app-spinner-loader",11),i&2){let t=d();l("color",t.appColors.PRIMARY)("borderWidth",2)("width",20)}}function Ze(i,n){if(i&1&&(c(0,"img",21),p(1)),i&2){let t=d();l("src",t.store.isStreamStarted()?"assets/icons/stop.png":"assets/icons/start.png",C),r(),_(" ",t.store.isStreamStarted()?t.lang.locals.stop:t.lang.locals.start," ")}}function Je(i,n){if(i&1&&(c(0,"app-spinner-loader",11),a(1,"span"),p(2),s()),i&2){let t=d();l("color",t.appColors.PRIMARY)("borderWidth",2)("width",20),r(2),w(t.lang.locals.loading)}}function Ke(i,n){if(i&1&&(c(0,"img",21),a(1,"span"),p(2),s()),i&2){let t=d();l("src","assets/icons/speak.png",C),r(2),w(t.lang.locals.click_to_speak)}}function Xe(i,n){if(i&1&&(c(0,"img",21),a(1,"span"),p(2),s()),i&2){let t=d();l("src","assets/icons/speak.png",C),r(2),w(t.lang.locals.listening_ongoing)}}function et(i,n){if(i&1&&(c(0,"div",40),U(1,"sanitizer"),a(2,"span"),p(3),s()),i&2){let t=d();l("innerHTML",de(1,2,t.svgIcons.SEND,"html"),D),r(3),w(t.lang.locals.click_to_send)}}function tt(i,n){if(i&1){let t=H();a(0,"div",43),h("animating",function(o){u(t);let m=d(2);return g(m.animationStatus.set(o))}),s()}if(i&2){let t=d().$implicit;l("text",t.content)}}function it(i,n){if(i&1&&c(0,"div",42),i&2){let t=d().$implicit;l("innerHtml",t.content,D)}}function nt(i,n){if(i&1&&(a(0,"div",48)(1,"div",49)(2,"small",50),p(3),c(4,"i",51),s()(),a(5,"a",52),p(6),s()()),i&2){let t=n.$implicit,e=n.$index;r(3),_(" doc ",e+1," "),r(3),w(t.filepath)}}function rt(i,n){if(i&1){let t=H();a(0,"div")(1,"div",44),h("click",function(){u(t);let o=q(6);return g(o.hidden=!o.hidden)}),c(2,"i",45),a(3,"span",46),p(4,"References"),s()(),a(5,"div",47,5),F(7,nt,7,2,"div",48,oe),s()()}if(i&2){let t=q(6),e=d().$implicit;r(2),l("ngClass",ce(1,We,t.hidden,!t.hidden)),r(5),j(e.context.citations)}}function ot(i,n){if(i&1&&(a(0,"div"),y(1,tt,1,1,"div",41)(2,it,1,1,"div",42)(3,rt,9,4,"div"),s()),i&2){let t=n.$implicit;re("message ",t.role,""),r(),f(t.role==="assistant"?1:2),r(2),f(t.context&&t.context.citations.length?3:-1)}}function at(i,n){if(i&1){let t=H();a(0,"div",53),h("click",function(){u(t);let o=d();return g(o.qrCodeOpened=!1)}),a(1,"div",54),h("click",function(o){return u(t),g(o.stopPropagation())}),c(2,"qrcode",55),a(3,"span",56),p(4),s(),a(5,"button",57),h("click",function(){u(t);let o=d();return g(o.qrCodeOpened=!1)}),k(),a(6,"svg",58),c(7,"path",15),s()()()()}if(i&2){let t=d();r(2),l("qrdata",t.getQRData()),r(2),_("streamId: ",t.store.streamId(),"")}}var G=class i extends Ve(class{}){baseElement=T.required("baseElement");waves=T.required("waves");video=T.required("video");idleVideo=T("idleVideo");chatContainer=T.required("container");avatarService=S(ke);lang=S(Se);store=S(Ce);chatService=S(W);chatHistoryService=S(He);speechService=S(be);injector=S(te);router=S(fe);svgIcons=we;appColors=ze;start$=new L(1);stop$=new L(1);recognizedText=A("");recognizingText=A("");recognized$=new I;accept$=new I;recognizingStatus=A(!1);animationStatus=A(!1);qrCodeOpened=!1;init$=this.start$.asObservable().pipe(x(()=>this.store.updateStreamStatus("InProgress"))).pipe(E(this.destroy$)).pipe($(()=>this.avatarService.startStream("life-size").pipe(J(n=>{throw this.store.updateStreamStatus("Stopped"),n})).pipe(Q()))).pipe(b(n=>{let{data:{webrtcData:{offer:t,iceServers:e}}}=n;return this.pc=new RTCPeerConnection({iceServers:e,iceTransportPolicy:"relay"}),this.pc.addEventListener("icecandidate",o=>{o.candidate&&this.avatarService.sendCandidate(o.candidate).subscribe()}),this.pc.addEventListener("icegatheringstatechange",o=>{o.target.iceGatheringState=="complete"&&this.video().nativeElement.paused&&(this.video().nativeElement.play().then(),this.store.updateStreamStatus("Started"))}),this.pc.addEventListener("track",o=>{this.video().nativeElement.srcObject=o.streams[0]}),this.pc.addEventListener("connectionstatechange",o=>{let m=o.target.connectionState;m==="connected"&&this.store.updateStreamStatus("Started"),m==="disconnected"&&this.store.updateStreamStatus("Stopped")}),R(this.pc.setRemoteDescription(new RTCSessionDescription(t))).pipe(b(()=>R(this.pc.createAnswer()))).pipe(b(o=>R(this.pc.setLocalDescription(o)).pipe(z(()=>o)))).pipe(b(o=>this.avatarService.sendAnswer(o)))})).pipe(z(()=>""));onlineStatus=me(()=>{switch(this.lang.localChange(),this.store.streamingStatus()){case"Started":return this.lang.locals.connected;case"InProgress":return this.lang.locals.connecting;case"Disconnecting":return this.lang.locals.disconnecting;default:return this.lang.locals.not_connected}});ngOnInit(){return Y(this,null,function*(){this.chatHistoryService.getAllBotNames().pipe(x(n=>this.chatService.botNameCtrl.patchValue(n[0]))).subscribe(),this.store.updateStreamStatus("Stopped"),Z(this.destroy$).pipe(x(()=>this.store.updateStreamStatus("Stopped"))).subscribe(()=>{console.log("COMPONENT DESTROYED")}),this.stop$.pipe(P(()=>this.store.hasStream())).pipe(x(()=>this.store.updateStreamStatus("Disconnecting"))).pipe(E(this.destroy$)).pipe(b(()=>this.avatarService.closeStream().pipe(Q()))).subscribe(()=>{this.store.updateStreamStatus("Stopped"),console.log("MANUAL CLOSE"),this.store.updateStreamStatus("Stopped")}),this.start$.next(),this.listenToAccept(),this.listenToBotNameChange(),this.prepareRecorder()})}ngAfterViewInit(){this.playIdle()}toggleStream(){this.store.isStreamLoading()||(this.store.isStreamStopped()?this.start$.next():this.stop$.next())}interruptAvatar(){this.avatarService.interruptAvatar().pipe(O(1)).subscribe()}clearChat(){this.chatService.messages.set([])}startRecording(){this.store.recordingInProgress(),this.recognizer.startContinuousRecognitionAsync(()=>{this.recognizer.internalData.privConnectionPromise.__zone_symbol__state===!0&&this.store.recordingStarted(),this.recognizingStatus.set(!0)})}stopRecording(){this.recognizer.stopContinuousRecognitionAsync(()=>{this.store.recordingStopped()})}toggleRecording(){this.store.isRecordingLoading()||(this.store.isRecordingStarted()?this.acceptText():this.startRecording())}acceptText(){this.accept$.next()}rejectText(){this.recognizingText.set(""),this.recognizedText.set(""),this.recognizingStatus.set(!1),this.stopRecording()}goToEndOfChat(){setTimeout(()=>{let n=this.chatContainer().nativeElement.querySelectorAll(".user");n[n.length-1].scrollIntoView({behavior:"smooth"})},100)}prepareRecorder(){this.waveSurfer=new Ie({waveColor:"white",progressColor:"white",container:this.waves().nativeElement,height:"auto"}),this.recorder=this.waveSurfer.registerPlugin(Le.create({scrollingWaveform:!1})),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>this.recorder.renderMicStream(e));let n=v.AudioConfig.fromDefaultMicrophoneInput(),t=v.AutoDetectSourceLanguageConfig.fromLanguages(["ar-QA","en-US"]);this.recognizer=v.SpeechRecognizer.FromConfig(v.SpeechConfig.fromAuthorizationToken(this.store.speechToken.token(),this.store.speechToken.region()),t,n),this.recognizer.recognizing=(e,o)=>{o.result.reason===v.ResultReason.RecognizingSpeech&&(this.recognizingText.set(this.recognizedText()+" "+o.result.text),this.recognizingStatus.set(!0))},this.recognizer.recognized=(e,o)=>{o.result.reason===v.ResultReason.RecognizedSpeech&&this.store.isRecordingStarted()&&(this.recognizedText.update(m=>m+" "+o.result.text),this.recognized$.next(),this.recognizingStatus.set(!1))},this.recognizer.canceled=()=>{this.store.recordingInProgress(),this.speechService.generateSpeechToken().pipe(O(1)).subscribe(()=>{this.prepareRecorder(),this.startRecording()})}}listenToAccept(){this.accept$.pipe(z(()=>this.recognizedText())).pipe(P(n=>!!n)).pipe(E(this.destroy$)).pipe(x(()=>{this.recognizedText.set(""),this.recognizingText.set(""),this.recognizingStatus.set(!1),this.stopRecording()})).pipe(x(()=>this.goToEndOfChat())).pipe($(n=>this.chatService.sendMessage(n,this.chatService.botNameCtrl.value))).pipe(K(200)).subscribe(()=>{let n=this.chatContainer().nativeElement.querySelectorAll(".assistant"),t=ue(()=>{this.animationStatus()||(n[n.length-1].scrollIntoView({behavior:"smooth"}),t.destroy())},{injector:this.injector})})}listenToBotNameChange(){this.chatService.onBotNameChange().pipe(E(this.destroy$)).subscribe()}toggleFullScreen(){document.fullscreenElement?document.exitFullscreen().then():this.baseElement().nativeElement.requestFullscreen().then()}isFullScreen(){return!!document.fullscreenElement}getQRData(){return`${this.getOrigin()}/control?streamId=${this.store.streamId()}`}getOrigin(){let n=location.href.lastIndexOf(this.router.url);return location.href.slice(0,n)}playIdle(){this.idleVideo()&&this.idleVideo()?.nativeElement&&(this.idleVideo().nativeElement.src=this.store.idleAvatarUrl(),this.idleVideo().nativeElement.muted=!0,this.idleVideo().nativeElement.loop=!0,this.idleVideo().nativeElement.play().then())}static \u0275fac=(()=>{let n;return function(e){return(n||(n=ee(i)))(e||i)}})();static \u0275cmp=X({type:i,selectors:[["app-temp-avatar"]],viewQuery:function(t,e){t&1&&(V(e.baseElement,De,5),V(e.waves,Fe,5),V(e.video,je,5),V(e.idleVideo,qe,5),V(e.chatContainer,Be,5)),t&2&&ae(5)},hostVars:2,hostBindings:function(t,e){t&2&&ne("block h-full w-full")},standalone:!0,features:[se([W]),ie,le],decls:55,vars:43,consts:[["baseElement",""],["waves",""],["video",""],["idleVideo",""],["container",""],["linkRef",""],[1,"relative","h-full","w-full","flex","items-center","justify-center","bg-secondary-100/80","rounded-xl","shadow"],[1,"flex","flex-col","items-center","h-full","justify-center","absolute"],[1,"absolute","w-[90%]","z-10","bottom-1/2","left-1/2","-translate-x-1/2","bg-black/70","text-white","text-sm","rounded","px-2","py-1"],[1,"absolute","-start-20","top-1/2","-translate-y-1/2","!w-16","flex","flex-col","gap-2"],[1,"!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"pointerdown","disabled"],[3,"color","borderWidth","width"],[1,"relative","w-full"],["matTooltipPosition","before","appButton","","shape","pill",1,"!p-1","!absolute","top-1/2","-translate-y-1/2","opacity-0","transition-all","duration-300",3,"click","matTooltip","ngClass"],["fill","currentColor","xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24",1,"w-5","h-5"],["d","M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"],[1,"relative","w-full","!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"relative","size-6"],["alt","start",1,"w-full","h-full",3,"src"],["alt","start",1,"absolute","top-0","left-0","w-full","h-full","opacity-60",3,"src"],["alt","start",1,"size-6",3,"src"],["fill","currentColor","xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24",1,"size-8"],["d","M3,11H5V13H3V11M11,5H13V9H11V5M9,11H13V15H11V13H9V11M15,11H17V13H19V11H21V13H19V15H21V19H19V21H17V19H13V21H11V17H15V15H17V13H15V11M19,19V15H17V19H19M15,3H21V9H15V3M17,5V7H19V5H17M3,3H9V9H3V3M5,5V7H7V5H5M3,15H9V21H3V15M5,17V19H7V17H5Z"],[1,"!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"click"],["d","M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M10,17V19H5V14H7V17H10Z"],[1,"w-full","absolute","top-2","px-2","flex","justify-between","items-center"],[1,"relative","flex","items-center","gap-2","shadow-2xl","shadow-white","bg-black/20","py-1","px-2","rounded-full"],[1,"text-white","text-sm","font-semibold"],[1,"p-2","rounded-full",3,"ngClass"],[1,"p-2","absolute","end-2","pulse","rounded-full",3,"ngClass"],[1,"w-28","h-6","overflow-hidden","transition-all","rounded-full","border","border-white/30",3,"ngClass"],[1,"w-full","pointer-events-none","h-full","opacity-90"],["autoplay","",1,"h-full",3,"hidden"],[1,"h-full",3,"hidden"],["type","video/webm",3,"src"],[1,"absolute","bottom-0","w-full","max-h-[45%]","overflow-y-auto","no-scrollbar","overflow-x-hidden"],[1,"min-h-0","flex-auto","flex","flex-col","gap-1","w-full","h-full","relative","overflow-hidden","py-1","px-2","[&>.message.user]:justify-start","[&>.message]:text-white"],[3,"class"],[1,"absolute","w-full","h-full","flex","items-center","justify-center","bg-black/80"],[1,"size-6",3,"innerHTML"],["appTextWriterAnimator","",1,"whitespace-pre-wrap","break-words",3,"text"],[1,"whitespace-pre-wrap","break-words",3,"innerHtml"],["appTextWriterAnimator","",1,"whitespace-pre-wrap","break-words",3,"animating","text"],[1,"icon-with-title",3,"click"],[1,"mdi",3,"ngClass"],[1,"title"],["hidden",""],["dir","auto"],[1,"d-inline"],[1,"px-1","text-primary"],[1,"mdi","mdi-link-variant"],[1,"d-inline","citation-link",2,"cursor","pointer"],[1,"absolute","w-full","h-full","flex","items-center","justify-center","bg-black/80",3,"click"],[1,"relative","flex","flex-col","justify-center","items-center","gap-2",3,"click"],[3,"qrdata"],[1,"p-1","text-white"],[1,"w-10","h-10","p-1","text-white","rounded-full","bg-white/30",3,"click"],["fill","currentColor","viewBox","0 0 24 24"]],template:function(t,e){if(t&1){let o=H();a(0,"div",6,0)(2,"div",7),y(3,Ge,2,1,"span",8),a(4,"div",9)(5,"button",10),h("pointerdown",function(){return u(o),g(e.toggleStream())}),y(6,Ye,1,3,"app-spinner-loader",11)(7,Ze,2,2),s(),a(8,"div",12)(9,"button",13),h("click",function(){return u(o),g(e.rejectText())}),k(),a(10,"svg",14),c(11,"path",15),s()(),M(),a(12,"button",16),h("click",function(){return u(o),g(e.toggleRecording())}),y(13,Je,3,4)(14,Ke,3,2)(15,Xe,3,2)(16,et,4,5),s()(),a(17,"button",17),h("click",function(){return u(o),g(e.interruptAvatar())}),a(18,"span",18),c(19,"img",19)(20,"img",20),s(),p(21),s(),a(22,"button",17),h("click",function(){return u(o),g(e.clearChat())}),c(23,"img",21),p(24),s(),a(25,"button",17),h("click",function(){return u(o),g(e.qrCodeOpened=!0)}),k(),a(26,"svg",22),c(27,"path",23),s(),p(28),s(),M(),a(29,"button",24),h("click",function(){return u(o),g(e.toggleFullScreen())}),k(),a(30,"svg",22),c(31,"path",25),s(),p(32),s()(),M(),a(33,"div",26)(34,"div",27)(35,"span",28),p(36),s(),c(37,"div",29)(38,"div",30),s(),a(39,"div",31),c(40,"div",32,1),s()(),c(42,"video",33,2),a(44,"video",34,3),c(46,"source",35),s(),a(47,"div",36)(48,"div",37,4),F(50,ot,4,5,"div",38,Ne),s()(),y(52,at,8,2,"div",39),s(),p(53),U(54,"async"),s()}t&2&&(r(3),f(e.recognizedText()?3:-1),r(2),l("disabled",e.store.isStreamLoading()),r(),f(e.store.isStreamLoading()?6:7),r(3),l("matTooltip",e.lang.locals.cancel_recording)("ngClass",B(31,Ue,e.store.isRecordingStarted())),r(3),l("disabled",e.store.isRecordingLoading()||e.recognizingStatus()),r(),f(e.store.isRecordingLoading()?13:-1),r(),f(e.store.isRecordingStopped()?14:-1),r(),f(e.store.isRecordingStarted()&&e.recognizingStatus()?15:-1),r(),f(e.store.isRecordingStarted()&&!e.recognizingStatus()?16:-1),r(),l("disabled",!e.store.isStreamStarted()),r(2),l("src","assets/icons/speak.png",C),r(),l("src","assets/icons/stop.png",C),r(),_(" ",e.lang.locals.stop_talking," "),r(),l("disabled",!e.chatService.messages().length),r(),l("src","assets/icons/clear-chat.png",C),r(),_(" ",e.lang.locals.clear_chat_history," "),r(),l("disabled",!e.store.isStreamStarted()),r(3),_(" ",e.lang.locals.qr_code," "),r(4),_(" ",e.lang.locals.full_screen," "),r(4),w(e.onlineStatus()),r(),l("ngClass",N(33,Pe,e.store.isStreamStopped(),e.store.isStreamStarted(),e.store.isStreamLoading())),r(),l("ngClass",N(37,Pe,e.store.isStreamStopped(),e.store.isStreamStarted(),e.store.isStreamLoading())),r(),l("ngClass",B(41,Qe,!e.store.isRecordingStarted())),r(3),l("hidden",e.store.isStreamStopped()||e.store.isStreamLoading()),r(2),l("hidden",e.store.isStreamStarted()),r(2),l("src",e.store.idleAvatarUrl(),C),r(4),j(e.chatService.messages()),r(2),f(e.qrCodeOpened&&e.store.isStreamStarted()?52:-1),r(),_(" ",pe(54,29,e.init$),`
`))},dependencies:[ve,ge,he,xe,Re,ye,Te,_e,Ee,Ae,Me],styles:['.message[_ngcontent-%COMP%]{position:relative;display:flex;flex-direction:column;font-size:.75rem;line-height:1rem}.message.user[_ngcontent-%COMP%]{align-items:flex-start}.message.user[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{border-radius:.375rem;border-top-right-radius:0;background-color:#00000080;padding:.125rem}.message.user[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:after{content:"";position:absolute;right:-8px;top:0;width:8px;height:8px;clip-path:polygon(0 0,100% 0,0 100%);background-color:inherit}.message.assistant[_ngcontent-%COMP%]{align-items:flex-end}.message.assistant[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{border-radius:.375rem;border-top-left-radius:0;background-color:#0003;padding:.125rem}.message.assistant[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:after{content:"";position:absolute;left:-8px;top:0;background-color:inherit;width:8px;height:8px;clip-path:polygon(0 0,100% 0,100% 100%)}']})};export{G as default};
